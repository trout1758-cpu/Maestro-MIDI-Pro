<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maestro Phase 5: Modular</title>
    
    <!-- Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,700;1,300&family=Noto+Music&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="flex flex-col h-screen">

    <!-- MAIN HEADER -->
    <header id="main-header" class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-6 z-20 shadow-sm relative">
        <div class="relative">
            <button id="parts-dropdown-btn" onclick="UIManager.toggleMenu('parts-menu')" class="flex items-center gap-3 px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors bg-white">
                <div class="bg-black text-white p-1 rounded"><i data-lucide="layers" size="18"></i></div>
                <div class="text-left leading-tight">
                    <span class="block text-xs font-bold text-gray-500 uppercase tracking-wide">Current Part</span>
                    <span id="current-part-label" class="block font-bold text-slate-800">No Part Selected</span>
                </div>
                <i data-lucide="chevron-down" size="16" class="text-gray-400 ml-2"></i>
            </button>
            <div id="parts-menu" class="dropdown-menu mt-2">
                <div id="parts-list-container" class="max-h-64 overflow-y-auto"></div>
                <button onclick="PartController.prepareCreate()" class="w-full text-left px-4 py-3 text-sm font-semibold text-blue-600 hover:bg-blue-50 border-t border-gray-100 flex items-center gap-2">
                    <i data-lucide="plus" size="16"></i> Add Part
                </button>
            </div>
        </div>
        
        <!-- Center Controls: Upload & Zoom -->
        <div class="flex items-center gap-4">
             <div class="flex items-center bg-gray-100 rounded-lg p-1 border border-gray-200 relative z-30">
                 <button onclick="FileManager.triggerUpload()" class="px-3 py-1 text-sm font-semibold hover:bg-white rounded shadow-sm transition-all flex gap-2 mr-2 cursor-pointer z-50">
                    <i data-lucide="upload" size="16"></i> Upload PDF
                </button>
                <input type="file" id="file-upload" accept="application/pdf" class="hidden">
                <div class="w-px h-5 bg-gray-300 mx-2"></div>
                <button onclick="PDF.adjustZoom(-0.1)" class="p-1 hover:text-blue-600"><i data-lucide="minus-circle" size="16"></i></button>
                <span class="text-xs font-mono w-12 text-center zoom-display">100%</span>
                <button onclick="PDF.adjustZoom(0.1)" class="p-1 hover:text-blue-600"><i data-lucide="plus-circle" size="16"></i></button>
            </div>

            <!-- Delete Mode Button -->
            <button id="delete-mode-btn" onclick="ToolbarView.toggleDelete(this)" class="flex items-center gap-2 px-4 py-2 border border-red-200 rounded-lg text-red-600 font-bold text-sm hover:bg-red-50 transition-colors" title="Toggle Delete Mode">
                <i data-lucide="trash-2" size="18"></i> Delete
            </button>
        </div>
        
        <button onclick="ExportManager.exportXML()" class="bg-slate-900 text-white px-5 py-2 rounded shadow hover:bg-slate-800 font-semibold text-sm flex items-center gap-2">
            Export XML <i data-lucide="arrow-right" size="16"></i>
        </button>
    </header>

    <!-- CALIBRATION HEADER -->
    <header id="calibration-header" class="bg-slate-900 border-b border-slate-700 h-16 flex items-center justify-between px-6 z-30 shadow-md">
        <div class="flex items-center gap-4">
            <div class="bg-orange-500 text-white p-1.5 rounded"><i data-lucide="ruler" size="20"></i></div>
            <div>
                <h1 class="text-lg font-bold text-white">Calibration Mode</h1>
                <p class="text-xs text-slate-400">Add systems and drag lines to match the staff.</p>
            </div>
        </div>

        <div class="flex items-center bg-slate-800 rounded-lg p-1 border border-slate-600">
            <button onclick="PDF.adjustZoom(-0.1)" class="p-1 text-slate-300 hover:text-white"><i data-lucide="minus-circle" size="16"></i></button>
            <span class="text-xs font-mono w-12 text-center text-slate-300 zoom-display">100%</span>
            <button onclick="PDF.adjustZoom(0.1)" class="p-1 text-slate-300 hover:text-white"><i data-lucide="plus-circle" size="16"></i></button>
        </div>

        <div class="flex items-center gap-3">
             <button onclick="CalibrationController.addSystem()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded font-bold text-sm shadow-sm flex items-center gap-2">
                <i data-lucide="plus-circle" size="16"></i> Add System
            </button>
             <button onclick="CalibrationController.clearAll()" class="bg-slate-700 hover:bg-red-600 text-white px-4 py-2 rounded font-semibold text-sm transition-colors">
                Clear All
            </button>
        </div>
    </header>

    <!-- CALIBRATION FOOTER -->
    <div id="calibration-footer">
        <button onclick="CalibrationController.exit(false)" class="text-slate-500 hover:text-slate-800 font-bold text-sm px-6 py-2 border border-slate-300 rounded hover:bg-slate-50">
            Cancel
        </button>
        <button onclick="CalibrationController.exit(true)" class="bg-green-600 hover:bg-green-500 text-white px-8 py-2 rounded font-bold text-sm shadow-lg shadow-green-900/20">
            Set Calibration
        </button>
    </div>

    <!-- CONTROL DECK -->
    <section id="control-deck" class="bg-white border-b border-gray-200 shadow-sm z-10 flex flex-col toolbar-disabled transition-all duration-300">
        <!-- TABS -->
        <div class="flex items-center justify-center gap-1 pt-1 border-b border-gray-100 overflow-x-auto">
            <button class="tab-btn" onclick="ToolbarView.toggleCategory('select')">Select</button>
            <button class="tab-btn" onclick="ToolbarView.toggleCategory('measure')">Measure</button>
            <button class="tab-btn" onclick="ToolbarView.toggleCategory('signature')">Signature</button>
            <button class="tab-btn" onclick="ToolbarView.toggleCategory('noterest')">Notes/Rests</button>
            <button class="tab-btn active" onclick="ToolbarView.toggleCategory('rhythm')">Rhythm/Duration</button>
            <button class="tab-btn" onclick="ToolbarView.toggleCategory('dynamics')">Dynamics</button>
            <button class="tab-btn" onclick="ToolbarView.toggleCategory('articulation')">Articulation</button>
        </div>

        <!-- TOOL CONTAINER -->
        <div class="h-28 bg-gray-50 flex items-center justify-center opacity-50 relative px-6 transition-opacity duration-200" id="tool-container">
            
            <!-- 0. SELECT (New) -->
            <div id="tools-select" class="flex gap-6 items-center justify-center w-full hidden">
                <button class="maestro-btn placeholder" title="Single Select" disabled>
                    <i data-lucide="mouse-pointer-2" size="24"></i>
                </button>
                <button class="maestro-btn placeholder relative" title="Multi-Select" disabled>
                    <i data-lucide="mouse-pointer-2" size="24" class="absolute top-3 left-3"></i>
                    <i data-lucide="mouse-pointer-2" size="24" class="absolute top-4 left-5 opacity-50 transform scale-75"></i>
                </button>
                <button class="maestro-btn placeholder relative" title="Measure Select" disabled>
                     <!-- Custom Measure Icon -->
                     <div class="measure-icon-container relative w-8 h-8 flex items-center justify-center">
                        <!-- Staff Lines -->
                        <div class="w-full h-4 border-t border-b border-gray-600 flex flex-col justify-center gap-0.5">
                            <div class="w-full h-px bg-gray-600"></div>
                            <div class="w-full h-px bg-gray-600"></div>
                            <div class="w-full h-px bg-gray-600"></div>
                        </div>
                        <!-- Bar Lines -->
                        <div class="absolute left-0 top-0 bottom-0 w-px bg-gray-800 h-6 mt-1"></div>
                        <div class="absolute right-0 top-0 bottom-0 w-px bg-gray-800 h-6 mt-1"></div>
                        <!-- Cursor Overlay -->
                        <i data-lucide="mouse-pointer-2" size="16" class="absolute -bottom-1 -right-2 text-black fill-black"></i>
                     </div>
                </button>
            </div>

            <!-- 1. MEASURE (Visuals) -->
            <div id="tools-measure" class="flex gap-4 items-center w-full justify-center hidden">
                <div class="flex gap-2">
                    <button class="maestro-btn tool-btn" title="Treble Clef" onclick="ToolbarView.selectTool('clef', 'treble', this)">ğ„</button>
                    <button class="maestro-btn tool-btn" title="Bass Clef" onclick="ToolbarView.selectTool('clef', 'bass', this)">ğ„¢</button>
                    <button class="maestro-btn tool-btn" title="Alto Clef (Movable C)" onclick="ToolbarView.selectTool('clef', 'c', this)">ğ„¡</button>
                </div>
                <div class="w-px h-8 bg-gray-300 mx-2"></div>
                <div class="flex gap-2">
                    <button class="maestro-btn tool-btn" title="Single Barline" onclick="ToolbarView.selectTool('barline', 'single', this)">ğ„€</button>
                    <button class="maestro-btn tool-btn" title="Double Barline" onclick="ToolbarView.selectTool('barline', 'double', this)">ğ„</button>
                    <button class="maestro-btn tool-btn" title="Final Barline" onclick="ToolbarView.selectTool('barline', 'final', this)">ğ„‚</button>
                    <button class="maestro-btn tool-btn" title="Repeat Sign" onclick="ToolbarView.selectTool('barline', 'repeat', this)">ğ„‡</button>
                </div>
                <div class="w-px h-8 bg-gray-300 mx-2"></div>
                <div class="flex gap-2">
                    <button class="maestro-btn tool-btn" title="Segno" onclick="ToolbarView.selectTool('symbol', 'segno', this)">ğ„‹</button>
                    <button class="maestro-btn tool-btn" title="Coda" onclick="ToolbarView.selectTool('symbol', 'coda', this)">ğ„Œ</button>
                </div>
            </div>

            <!-- 2. SIGNATURE (Fixed Layout) -->
            <div id="tools-signature" class="flex flex-col gap-2 items-center w-full hidden">
                <div class="flex gap-1 justify-center">
                    <button class="maestro-btn sig-btn tool-btn" title="2/2" onclick="ToolbarView.selectTool('time', '2/2', this)">2/2</button>
                    <button class="maestro-btn sig-btn tool-btn" title="3/2" onclick="ToolbarView.selectTool('time', '3/2', this)">3/2</button>
                    <button class="maestro-btn sig-btn tool-btn" title="4/2" onclick="ToolbarView.selectTool('time', '4/2', this)">4/2</button>
                    <button class="maestro-btn sig-btn tool-btn" title="2/4" onclick="ToolbarView.selectTool('time', '2/4', this)">2/4</button>
                    <button class="maestro-btn sig-btn tool-btn" title="3/4" onclick="ToolbarView.selectTool('time', '3/4', this)">3/4</button>
                    <button class="maestro-btn sig-btn tool-btn" title="4/4" onclick="ToolbarView.selectTool('time', '4/4', this)">4/4</button>
                    <button class="maestro-btn sig-btn tool-btn" title="5/4" onclick="ToolbarView.selectTool('time', '5/4', this)">5/4</button>
                    <button class="maestro-btn sig-btn tool-btn" title="3/8" onclick="ToolbarView.selectTool('time', '3/8', this)">3/8</button>
                    <button class="maestro-btn sig-btn tool-btn" title="6/8" onclick="ToolbarView.selectTool('time', '6/8', this)">6/8</button>
                    <button class="maestro-btn sig-btn tool-btn" title="9/8" onclick="ToolbarView.selectTool('time', '9/8', this)">9/8</button>
                    <button class="maestro-btn sig-btn tool-btn" title="12/8" onclick="ToolbarView.selectTool('time', '12/8', this)">12/8</button>
                </div>
                <div class="flex gap-1 justify-center">
                    <button class="maestro-btn key-btn bg-red-50 text-red-700 border-red-200 tool-btn" onclick="ToolbarView.selectTool('key', 'A#', this)">Aâ™¯</button>
                    <button class="maestro-btn key-btn bg-red-50 text-red-700 border-red-200 tool-btn" onclick="ToolbarView.selectTool('key', 'B#', this)">Bâ™¯</button>
                    <button class="maestro-btn key-btn bg-red-50 text-red-700 border-red-200 tool-btn" onclick="ToolbarView.selectTool('key', 'C#', this)">Câ™¯</button>
                    <button class="maestro-btn key-btn bg-red-50 text-red-700 border-red-200 tool-btn" onclick="ToolbarView.selectTool('key', 'D#', this)">Dâ™¯</button>
                    <button class="maestro-btn key-btn bg-red-50 text-red-700 border-red-200 tool-btn" onclick="ToolbarView.selectTool('key', 'E#', this)">Eâ™¯</button>
                    <button class="maestro-btn key-btn bg-red-50 text-red-700 border-red-200 tool-btn" onclick="ToolbarView.selectTool('key', 'F#', this)">Fâ™¯</button>
                    <button class="maestro-btn key-btn bg-red-50 text-red-700 border-red-200 tool-btn" onclick="ToolbarView.selectTool('key', 'G#', this)">Gâ™¯</button>
                    <div class="w-px h-8 bg-gray-300 mx-1"></div>
                    <button class="maestro-btn key-btn tool-btn" onclick="ToolbarView.selectTool('key', 'A', this)">A</button>
                    <button class="maestro-btn key-btn tool-btn" onclick="ToolbarView.selectTool('key', 'B', this)">B</button>
                    <button class="maestro-btn key-btn tool-btn" onclick="ToolbarView.selectTool('key', 'C', this)">C</button>
                    <button class="maestro-btn key-btn tool-btn" onclick="ToolbarView.selectTool('key', 'D', this)">D</button>
                    <button class="maestro-btn key-btn tool-btn" onclick="ToolbarView.selectTool('key', 'E', this)">E</button>
                    <button class="maestro-btn key-btn tool-btn" onclick="ToolbarView.selectTool('key', 'F', this)">F</button>
                    <button class="maestro-btn key-btn tool-btn" onclick="ToolbarView.selectTool('key', 'G', this)">G</button>
                    <div class="w-px h-8 bg-gray-300 mx-1"></div>
                    <button class="maestro-btn key-btn bg-blue-50 text-blue-700 border-blue-200 tool-btn" onclick="ToolbarView.selectTool('key', 'Ab', this)">Aâ™­</button>
                    <button class="maestro-btn key-btn bg-blue-50 text-blue-700 border-blue-200 tool-btn" onclick="ToolbarView.selectTool('key', 'Bb', this)">Bâ™­</button>
                    <button class="maestro-btn key-btn bg-blue-50 text-blue-700 border-blue-200 tool-btn" onclick="ToolbarView.selectTool('key', 'Cb', this)">Câ™­</button>
                    <button class="maestro-btn key-btn bg-blue-50 text-blue-700 border-blue-200 tool-btn" onclick="ToolbarView.selectTool('key', 'Db', this)">Dâ™­</button>
                    <button class="maestro-btn key-btn bg-blue-50 text-blue-700 border-blue-200 tool-btn" onclick="ToolbarView.selectTool('key', 'Eb', this)">Eâ™­</button>
                    <button class="maestro-btn key-btn bg-blue-50 text-blue-700 border-blue-200 tool-btn" onclick="ToolbarView.selectTool('key', 'Fb', this)">Fâ™­</button>
                    <button class="maestro-btn key-btn bg-blue-50 text-blue-700 border-blue-200 tool-btn" onclick="ToolbarView.selectTool('key', 'Gb', this)">Gâ™­</button>
                </div>
            </div>

            <!-- 3. NOTES/RESTS (Fixed Layout) -->
            <div id="tools-noterest" class="flex gap-6 items-center justify-center w-full hidden">
                <!-- Accidentals (Left) -->
                <div class="flex gap-2">
                    <button class="maestro-btn note-grid-btn accidental-btn placeholder opacity-50 cursor-not-allowed" disabled title="Sharp" onclick="ToolbarView.toggleAccidental('sharp', this)">â™¯</button>
                    <button class="maestro-btn note-grid-btn accidental-btn placeholder opacity-50 cursor-not-allowed" disabled title="Natural" onclick="ToolbarView.toggleAccidental('natural', this)">â™®</button>
                    <button class="maestro-btn note-grid-btn accidental-btn placeholder opacity-50 cursor-not-allowed" disabled title="Flat" onclick="ToolbarView.toggleAccidental('flat', this)">â™­</button>
                </div>
                <!-- Notes/Rests Grid (Center) -->
                <div class="flex flex-col gap-2">
                    <div class="flex gap-2">
                        <button class="maestro-btn note-grid-btn tool-btn" onclick="ToolbarView.selectTool('note', 1, this)">ğ…</button>
                        <button class="maestro-btn note-grid-btn tool-btn" onclick="ToolbarView.selectTool('note', 2, this)">ğ…</button>
                        <button class="maestro-btn note-grid-btn tool-btn active" onclick="ToolbarView.selectTool('note', 4, this)">ğ…Ÿ</button>
                        <button class="maestro-btn note-grid-btn tool-btn" onclick="ToolbarView.selectTool('note', 8, this)">ğ… </button>
                        <button class="maestro-btn note-grid-btn tool-btn" onclick="ToolbarView.selectTool('note', 16, this)">ğ…¡</button>
                    </div>
                    <div class="flex gap-2">
                        <button class="maestro-btn note-grid-btn tool-btn" onclick="ToolbarView.selectTool('rest', 1, this)">ğ„»</button>
                        <button class="maestro-btn note-grid-btn tool-btn" onclick="ToolbarView.selectTool('rest', 2, this)">ğ„¼</button>
                        <button class="maestro-btn note-grid-btn tool-btn" onclick="ToolbarView.selectTool('rest', 4, this)">ğ„½</button>
                        <button class="maestro-btn note-grid-btn tool-btn" onclick="ToolbarView.selectTool('rest', 8, this)">ğ„¾</button>
                        <button class="maestro-btn note-grid-btn tool-btn" onclick="ToolbarView.selectTool('rest', 16, this)">ğ„¿</button>
                    </div>
                </div>
                <!-- Dot (Right) -->
                <div>
                    <button class="maestro-btn note-grid-btn text-4xl pb-4" title="Dot" onclick="ToolbarView.toggleDot(this)">.</button>
                </div>
            </div>

            <!-- 4. RHYTHM/DURATION -->
            <div id="tools-rhythm" class="flex items-center justify-center w-full gap-16">
                
                <!-- Left: Tempo -->
                <button class="maestro-btn placeholder double-width-btn" title="Tempo Marking">Tempo</button>

                <!-- Center Grid -->
                <div class="flex flex-col gap-2">
                    <!-- Top Row -->
                    <div class="flex gap-2">
                        <button class="maestro-btn placeholder note-grid-btn" title="Fermata">ğ„</button>
                        <button class="maestro-btn placeholder note-grid-btn text-xl" title="Caesura">//</button>
                        <button class="maestro-btn placeholder note-grid-btn text-xs italic font-serif" title="a tempo">a t.</button>
                    </div>
                    <!-- Bottom Row -->
                    <div class="flex gap-2">
                        <button class="maestro-btn placeholder note-grid-btn text-xs italic font-serif" title="ritardando">rit.</button>
                        <button class="maestro-btn placeholder note-grid-btn text-xs italic font-serif" title="accelerando">acc.</button>
                        <button class="maestro-btn placeholder note-grid-btn text-xs italic font-serif" title="poco">poco</button>
                    </div>
                </div>

                <!-- Right Stack -->
                <div class="flex flex-col gap-2 relative">
                    <!-- Tie Button -->
                    <button class="maestro-btn placeholder double-width-btn flex flex-col items-center justify-center p-0" title="Tie" onclick="ToolbarView.toggleTie(this)">
                        <span class="text-3xl leading-3 mt-3 transform scale-x-[4] origin-center">â€</span>
                        <span class="text-xs font-serif italic mb-1">tie</span>
                    </button>
                    
                    <!-- Triplet Button (Bottom, with Dropdown) -->
                    <div class="relative group" id="tuplet-container">
                        <button id="tuplet-btn" class="maestro-btn placeholder double-width-btn flex items-center justify-between px-2" onclick="UIManager.toggleMenu('tuplet-menu')" title="Tuplet">
                            <div id="tuplet-display" class="flex flex-col items-center justify-center w-full">
                                <div class="text-xs -mb-2">â”Œ 3 â”</div>
                                <div class="text-xl tracking-tighter">ğ…Ÿğ…Ÿğ…Ÿ</div> 
                            </div>
                            <i data-lucide="chevron-down" size="14" class="text-gray-400 ml-1"></i>
                        </button>
                        <!-- Tuplet Menu -->
                        <div id="tuplet-menu" class="tuplet-dropdown">
                            <div class="tuplet-item" onclick="UIManager.selectTuplet(2, 'â”Œ 2 â”', 'ğ…Ÿğ…Ÿ')">Duplets (2)</div>
                            <div class="tuplet-item" onclick="UIManager.selectTuplet(3, 'â”Œ 3 â”', 'ğ…Ÿğ…Ÿğ…Ÿ')">Triplets (3)</div>
                            <div class="tuplet-item" onclick="UIManager.selectTuplet(4, 'â”Œ 4 â”', 'ğ…Ÿğ…Ÿğ…Ÿğ…Ÿ')">Quadruplets (4)</div>
                            <div class="tuplet-item" onclick="UIManager.selectTuplet(5, 'â”Œ 5 â”', 'ğ…Ÿğ…Ÿğ…Ÿğ…Ÿğ…Ÿ')">Quintuplets (5)</div>
                            <div class="tuplet-item" onclick="UIManager.selectTuplet(6, 'â”Œ 6 â”', 'ğ…Ÿğ…Ÿğ…Ÿğ…Ÿğ…Ÿğ…Ÿ')">Sextuplets (6)</div>
                            <div class="tuplet-item" onclick="UIManager.selectTuplet(7, 'â”Œ 7 â”', 'ğ…Ÿğ…Ÿğ…Ÿğ…Ÿğ…Ÿğ…Ÿğ…Ÿ')">Septuplets (7)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. DYNAMICS (Refactored Layout & Sizes) -->
            <div id="tools-dynamics" class="flex gap-6 items-center justify-center w-full hidden">
                <!-- Dynamics Grid -->
                <div class="flex flex-col gap-2">
                    <!-- Top Row: Louds & Crescendo -->
                    <div class="flex gap-2 items-center">
                         <button class="maestro-btn placeholder note-grid-btn" title="mf">ğ†ğ†‘</button>
                         <button class="maestro-btn placeholder note-grid-btn" title="f">ğ†‘</button>
                         <button class="maestro-btn placeholder note-grid-btn" title="ff">ğ†‘ğ†‘</button>
                         <button class="maestro-btn placeholder note-grid-btn" title="fff">ğ†‘ğ†‘ğ†‘</button>
                         <!-- Crescendo: Double width, stretched hairpin -->
                         <button class="maestro-btn placeholder double-width-btn flex items-center justify-center overflow-hidden" title="Crescendo">
                            <span class="text-3xl font-light transform scale-x-[3.5] origin-center -mt-1">&lt;</span>
                         </button>
                    </div>
                    <!-- Bottom Row: Softs & Diminuendo -->
                    <div class="flex gap-2 items-center">
                         <button class="maestro-btn placeholder note-grid-btn" title="mp">ğ†ğ†</button>
                         <button class="maestro-btn placeholder note-grid-btn" title="p">ğ†</button>
                         <button class="maestro-btn placeholder note-grid-btn" title="pp">ğ†ğ†</button>
                         <button class="maestro-btn placeholder note-grid-btn" title="ppp">ğ†ğ†ğ†</button>
                         <!-- Diminuendo: Double width, stretched hairpin -->
                         <button class="maestro-btn placeholder double-width-btn flex items-center justify-center overflow-hidden" title="Diminuendo">
                            <span class="text-3xl font-light transform scale-x-[3.5] origin-center -mt-1">&gt;</span>
                         </button>
                    </div>
                </div>
            
                <!-- Divider -->
                <div class="w-px h-20 bg-gray-300"></div>
            
                <!-- Centered SFZ -->
                <div>
                    <button class="maestro-btn placeholder note-grid-btn text-sm italic font-serif" title="sfz">sfz</button>
                </div>
            </div>

             <!-- 6. ARTICULATION (Updated Layout) -->
             <div id="tools-articulation" class="flex flex-col gap-2 items-center justify-center w-full hidden">
                <!-- Top Row -->
                <div class="flex gap-2 items-center">
                    <button class="maestro-btn placeholder note-grid-btn text-xl" title="Accent">&gt;</button>
                    <button class="maestro-btn placeholder note-grid-btn text-3xl pb-2" title="Staccato">.</button>
                    <button class="maestro-btn placeholder note-grid-btn text-xl mt-2" title="Marcato">^</button>
                    <button class="maestro-btn placeholder note-grid-btn text-xl" title="Percussive">x</button>
                    <button class="maestro-btn placeholder note-grid-btn text-2xl" title="Diamond">â—‡</button>
                    <!-- Legato -->
                    <button class="maestro-btn placeholder double-width-btn flex flex-col items-center justify-center p-0" title="Legato">
                        <span class="text-xs font-serif italic mt-1">leg.</span>
                        <span class="text-3xl leading-3 mb-2 transform rotate-180 scale-x-[4] origin-center">â€</span>
                    </button>
                </div>
                <!-- Bottom Row -->
                <div class="flex gap-2 items-center">
                    <button class="maestro-btn placeholder note-grid-btn text-sm italic font-serif" title="Trill">tr</button>
                    <button class="maestro-btn placeholder note-grid-btn text-xl" title="Tremolo">///</button>
                    <button class="maestro-btn placeholder note-grid-btn text-xs italic font-serif" title="Glissando">gliss</button>
                    <!-- Arpeggiated Roll -->
                    <button class="maestro-btn placeholder note-grid-btn text-2xl" title="Arpeggio">ğ†ƒ</button> 
                    <button class="maestro-btn placeholder note-grid-btn text-xs italic font-serif" title="8va">8va</button>
                    <!-- Sustain -->
                    <button class="maestro-btn placeholder double-width-btn flex items-center justify-center" title="Sustain">
                        <div class="w-24 h-4 border-b border-l border-r border-gray-500 relative">
                            <span class="absolute -top-3 left-1/2 -translate-x-1/2 text-xs font-serif italic bg-white px-1">sus.</span>
                        </div>
                    </button>
                </div>
           </div>
            
            <!-- Right Aligned Pitch Indicator -->
            <div class="absolute right-6 flex items-center gap-3">
                <div id="pitch-display" class="bg-white border border-gray-200 rounded px-3 py-1 text-2xl font-serif text-blue-600 font-bold min-w-[3rem] text-center shadow-sm">
                    -
                </div>
            </div>
        </div>
    </section>

    <!-- MAIN VIEWPORT -->
    <main id="viewport" class="p-12 flex justify-center">
        <div id="canvas-wrapper">
            <canvas id="pdf-render"></canvas>
            <div id="overlay-layer">
                <!-- Notes will be injected here -->
            </div>
        </div>
    </main>

    <!-- MODALS -->
    <div id="part-modal" class="modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl w-96 overflow-hidden">
            <div class="bg-slate-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                <h2 id="modal-title" class="text-lg font-bold text-slate-800">Create New Part</h2>
                <button onclick="UIManager.closeModals()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" size="20"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Part Name</label>
                    <input type="text" id="part-name" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Instrument</label>
                    <select id="part-instrument" class="w-full px-3 py-2 border border-gray-300 rounded bg-white">
                        <option value="Voice">Voice</option>
                        <option value="Piano">Piano</option>
                        <option value="Violin">Violin</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Default Clef</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="ModalView.selectClef('treble', this)" class="clef-btn active flex items-center justify-center border rounded p-2 hover:bg-gray-50 border-blue-500 bg-blue-50 text-blue-600">
                            <span class="font-music text-2xl mr-2">ğ„</span> Treble
                        </button>
                        <button onclick="ModalView.selectClef('bass', this)" class="clef-btn flex items-center justify-center border rounded p-2 hover:bg-gray-50 text-gray-600">
                            <span class="font-music text-2xl mr-2">ğ„¢</span> Bass
                        </button>
                    </div>
                    <input type="hidden" id="part-clef" value="treble">
                </div>
                <button id="modal-calibrate-btn" onclick="PartController.saveAndCalibrate()" class="w-full py-2 border border-gray-300 rounded font-semibold text-sm flex items-center justify-center gap-2 mt-2 bg-white text-blue-600 border-blue-200 hover:bg-blue-50">
                    <i data-lucide="ruler"></i> Calibrate Staff
                </button>
            </div>
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-between items-center">
                <button id="btn-delete-part" onclick="PartController.confirmDelete()" class="text-red-500 text-sm font-bold hover:text-red-700 hidden">Delete</button>
                <div class="flex gap-2 ml-auto">
                    <button onclick="UIManager.closeModals()" class="px-4 py-2 text-sm font-semibold text-gray-600 hover:text-gray-800">Cancel</button>
                    <button onclick="PartController.save()" class="px-4 py-2 text-sm font-bold text-white bg-blue-600 rounded hover:bg-blue-700 shadow-sm">Save Part</button>
                </div>
            </div>
        </div>
    </div>

    <div id="delete-modal" class="modal-overlay">
        <div class="bg-white rounded-lg shadow-xl p-6 w-80 text-center">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Delete Part?</h3>
            <p class="text-sm text-gray-600 mb-6">Are you sure you want to delete <span id="delete-part-name" class="font-bold"></span>?</p>
            <div class="flex justify-center gap-3">
                <button onclick="UIManager.closeModals()" class="px-4 py-2 text-sm font-semibold border rounded hover:bg-gray-50">Cancel</button>
                <button onclick="PartController.delete()" class="px-4 py-2 text-sm font-bold text-white bg-red-600 rounded hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <!-- MAIN SCRIPT ENTRY -->
    <script type="module" src="js/main.js"></script>
</body>
</html>
